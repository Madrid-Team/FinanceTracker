name: CI | Pull Request Validation

on:
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]
    branches:
      - develop

jobs:
  validate-pr:
    name: PR Validation Workflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name : Notify Madrid Team - PR Opened
      - uses: act10ns/slack@v2
        if : github.event.action =='opened'
        with:
          channel: 'madrid-squad'
          steps: ${{toJson(steps)}}
          payload: |
            {
            "text":  "ğŸš€ *New Pull Request* by @${{ github.actor }} â†’ \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>\"
            }
        env:
          SLACK_WEBHOOK_URL: ${{secrets.SLACK_MADRID_CHAT_SECRET}}

      - name : Notify Madrid Team - PR Opened
      - uses: act10ns/slack@v2
        if : github.event.action =='reopened'
        with:
          channel: 'madrid-squad'
          steps: ${{toJson(steps)}}
          payload: |
            {
            "text":  "ğŸš€ *Reopened Pull Request* by @${{ github.actor }} â†’ \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>\"
            }
        env:
          SLACK_WEBHOOK_URL: ${{secrets.SLACK_MADRID_CHAT_SECRET}}

      - name: Notify Slack â€” Tests Passed
        uses: act10ns/slack@v2
        if: success()
        with:
          channel: 'madrid-squad'
          steps: ${{toJson(steps)}}
          payload: |
            {
              "text": "âœ… *All Tests Passed* on PR #${{ github.event.pull_request.number }} \`${{ github.head_ref }}\` -> \`${{ github.base_ref }}\ by @${{ github.actor }}\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{secrets.SLACK_MADRID_CHAT_SECRET}}

      - name: Notify Slack â€” Tests Failed
        uses: act10ns/slack@v2
        if: failure()
        with:
          channel: 'madrid-squad'
          steps: ${{toJson(steps)}}
          payload: |
            {
              "text": "âŒ *Test Execution Failed* on PR #${{ github.event.pull_request.number }} \`${{ github.head_ref }}\` -> \`${{ github.base_ref }}\  by @${{ github.actor }}\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{secrets.SLACK_MADRID_CHAT_SECRET}}


      - name: Notify Slack â€” PR Opened or Ready for Review
        if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"ğŸš€ *New Pull Request* opened by @${{ github.actor }} â†’ \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>\"
          }" ${{ secrets.SLACK_SECRET }}

      - name: Set Up Java 17 Environment
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Grant Execute Permission to Gradle Wrapper
        run: chmod +x ./gradlew

      - name: Run Unit Tests
        run: ./gradlew test --no-daemon --stacktrace

      - name: Execute Main Application (Main.kt)
        run: ./gradlew run --no-daemon

      - name: Notify Slack â€” Tests Passed
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"âœ… *All Tests Passed* on PR #${{ github.event.pull_request.number }} by @${{ github.actor }}\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>\"
          }" ${{ secrets.SLACK_SECRET }}

      - name: Notify Slack â€” Tests Failed
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"âŒ *Test Execution Failed* on PR #${{ github.event.pull_request.number }} by @${{ github.actor }}\nğŸ”— <${{ github.event.pull_request.html_url }}|View Pull Request>\"
          }" ${{ secrets.SLACK_SECRET }}
